<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSG Health Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .admin-section {
            display: none;
        }
        .admin-section.active {
            display: block;
        }
        .preview-image {
            max-width: 200px;
            max-height: 200px;
            object-fit: cover;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        .notification.show {
            transform: translateX(0);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online {
            background-color: #10b981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
        }
        .status-offline {
            background-color: #ef4444;
        }
        .real-time-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1000;
        }
        
        /* Mobile responsive enhancements */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 50;
                background: white;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            }
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0 !important;
            }
            .mobile-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 40;
            }
            .mobile-overlay.active {
                display: block;
            }
            .notification {
                right: 10px;
                left: 10px;
                transform: translateY(-100px);
            }
            .notification.show {
                transform: translateY(0);
            }
            .real-time-indicator {
                bottom: 10px;
                left: 10px;
                font-size: 12px;
                padding: 6px 12px;
            }
            .responsive-grid {
                grid-template-columns: 1fr !important;
            }
            .responsive-flex {
                flex-direction: column !important;
            }
            .responsive-form {
                padding: 1rem !important;
            }
        }
        
        /* Improved mobile forms */
        @media (max-width: 640px) {
            .form-grid {
                grid-template-columns: 1fr !important;
            }
            .equipment-item {
                flex-direction: column !important;
                align-items: flex-start !important;
            }
            .equipment-actions {
                margin-top: 1rem;
                align-self: stretch;
                display: flex;
                justify-content: space-between;
            }
        }

        /* Enhanced authentication check */
        .auth-loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(59, 130, 246, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        /* Modal Login System */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(10px);
        }

        .auth-modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            position: relative;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .admin-content {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .admin-content.authenticated {
            display: block;
            opacity: 1;
        }

        /* Anti-bypass protection */
        .admin-content:not(.authenticated) * {
            pointer-events: none !important;
            user-select: none !important;
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Session timeout warning */
        .session-warning {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 10001;
            max-width: 400px;
            width: 90%;
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Modal Login System -->
    <div id="authModal" class="auth-modal">
        <div class="auth-modal-content">
            <div class="text-center mb-6">
                <!-- NSG Health Logo -->
                <div class="flex justify-center mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="relative">
                            <svg width="40" height="35" viewBox="0 0 40 35" class="text-white">
                                <path d="M20 32C20 32 3 22 3 12C3 7 7 3 12 3C15 3 18 5 20 8C22 5 25 3 28 3C33 3 37 7 37 12C37 22 20 32 20 32Z" fill="currentColor"/>
                                <path d="M8 15L12 15L14 11L16 19L18 11L20 15L32 15" stroke="black" stroke-width="1.5" fill="none"/>
                            </svg>
                        </div>
                        <div class="flex flex-col">
                            <div class="flex items-baseline space-x-1">
                                <span class="text-2xl font-bold text-white">NSG</span>
                                <span class="text-2xl font-bold text-blue-200">HEALTH</span>
                            </div>
                            <span class="text-sm text-blue-200 -mt-1" style="font-family: 'Brush Script MT', cursive; font-style: italic;">Admin Access Required</span>
                        </div>
                    </div>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">Admin Authentication</h2>
                <p class="text-blue-100 text-sm">This is a protected area. Please log in to continue.</p>
            </div>

            <form id="modalLoginForm" class="space-y-4">
                <div id="modalErrorMessage" class="hidden bg-red-500 bg-opacity-20 border border-red-300 text-red-100 px-4 py-3 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <span id="modalErrorText">Invalid credentials</span>
                    </div>
                </div>

                <div>
                    <label for="modalUsername" class="block text-white font-medium mb-2">
                        <i class="fas fa-user mr-2"></i>Username
                    </label>
                    <input type="text" id="modalUsername" name="username" 
                           class="w-full px-4 py-3 bg-white bg-opacity-20 border border-white border-opacity-30 rounded-lg text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50" 
                           placeholder="Enter username" required>
                </div>

                <div>
                    <label for="modalPassword" class="block text-white font-medium mb-2">
                        <i class="fas fa-lock mr-2"></i>Password
                    </label>
                    <div class="relative">
                        <input type="password" id="modalPassword" name="password" 
                               class="w-full px-4 py-3 bg-white bg-opacity-20 border border-white border-opacity-30 rounded-lg text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50" 
                               placeholder="Enter password" required>
                        <button type="button" id="modalTogglePassword" class="absolute right-3 top-3 text-blue-200 hover:text-white">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <label class="flex items-center text-blue-100">
                        <input type="checkbox" id="modalRememberMe" class="mr-2 rounded">
                        <span class="text-sm">Remember me</span>
                    </label>
                    <div class="text-xs text-blue-200">Session timeout: 1 hour</div>
                </div>

                <button type="submit" class="w-full bg-white text-blue-600 font-semibold py-3 rounded-lg hover:bg-blue-50 transition-colors">
                    <i class="fas fa-sign-in-alt mr-2"></i>Access Admin Panel
                </button>
            </form>

            <div class="mt-6 text-center">
                <a href="index.html" class="text-blue-200 hover:text-white text-sm">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Website
                </a>
            </div>

            <!-- Session timeout display -->
            <div id="sessionTimer" class="mt-4 text-center text-blue-200 text-xs hidden">
                Session expires in: <span id="timeRemaining">--:--</span>
            </div>
        </div>
    </div>

    <!-- Session Warning Modal -->
    <div id="sessionWarning" class="session-warning">
        <div class="text-center">
            <i class="fas fa-clock text-4xl text-yellow-500 mb-4"></i>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Session Expiring Soon</h3>
            <p class="text-gray-600 mb-4">Your session will expire in <span id="warningTime">5</span> minutes. Do you want to extend it?</p>
            <div class="flex space-x-3 justify-center">
                <button onclick="extendSession()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-refresh mr-2"></i>Extend Session
                </button>
                <button onclick="forceLogout()" class="bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500 transition-colors">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </div>
    </div>

    <!-- All admin content wrapped in authenticated container -->
    <div id="adminContent" class="admin-content">
    <!-- Authentication Loading Screen -->
    <div id="authLoading" class="auth-loading" style="display: none;">
        <div class="text-center text-white">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-white mb-4 mx-auto"></div>
            <p class="text-xl">Verifying session...</p>
        </div>
    </div>

    <!-- Mobile Overlay -->
    <div id="mobileOverlay" class="mobile-overlay"></div>

    <!-- Notification Container -->
    <div id="notification" class="notification bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg">
        <span id="notificationText">Changes saved successfully!</span>
    </div>

    <!-- Real-time Status Indicator -->
    <div id="realTimeStatus" class="real-time-indicator">
        <span class="status-indicator status-online"></span>
        Real-time sync active
    </div>

    <!-- Header -->
    <header class="bg-blue-800 text-white shadow-lg relative z-30">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <!-- Mobile Menu Button -->
                <button id="mobileMenuBtn" class="md:hidden text-white p-2 rounded-lg hover:bg-blue-700">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                
                <div class="flex items-center space-x-3">
                    <!-- NSG Health Logo -->
                    <div class="relative">
                        <svg width="35" height="30" viewBox="0 0 40 35" class="text-red-500">
                            <path d="M20 32C20 32 3 22 3 12C3 7 7 3 12 3C15 3 18 5 20 8C22 5 25 3 28 3C33 3 37 7 37 12C37 22 20 32 20 32Z" fill="currentColor"/>
                            <path d="M8 15L12 15L14 11L16 19L18 11L20 15L32 15" stroke="black" stroke-width="1.5" fill="none"/>
                        </svg>
                    </div>
                    <div class="hidden sm:block">
                        <h1 class="text-xl md:text-2xl font-bold">NSG Health Admin</h1>
                        <p class="text-blue-200 text-xs md:text-sm">Content Management System</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2 md:space-x-4">
                    <span class="text-blue-200 text-sm md:text-base hidden sm:block" id="currentUser">Welcome, Admin</span>
                    <button onclick="previewWebsite()" class="bg-blue-600 hover:bg-blue-700 px-2 md:px-4 py-2 rounded-lg transition-colors text-sm">
                        <i class="fas fa-eye mr-1 md:mr-2"></i><span class="hidden sm:inline">Preview</span>
                    </button>
                    <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-2 md:px-4 py-2 rounded-lg transition-colors text-sm">
                        <i class="fas fa-sign-out-alt mr-1 md:mr-2"></i><span class="hidden sm:inline">Logout</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="flex">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar w-64 bg-white shadow-lg min-h-screen">
            <nav class="p-4">
                <ul class="space-y-2">
                    <li>
                        <button onclick="showSection('dashboard')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors admin-nav-btn active">
                            <i class="fas fa-tachometer-alt mr-3"></i>Dashboard
                        </button>
                    </li>
                    <li>
                        <button onclick="showSection('equipment')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors admin-nav-btn">
                            <i class="fas fa-medkit mr-3"></i>Equipment Management
                        </button>
                    </li>
                    <li>
                        <button onclick="showSection('medicine')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors admin-nav-btn">
                            <i class="fas fa-pills mr-3"></i>Medicine Management
                        </button>
                    </li>
                    <li>
                        <button onclick="showSection('blogs')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors admin-nav-btn">
                            <i class="fas fa-blog mr-3"></i>Blog Management
                        </button>
                    </li>
                    <li>
                        <button onclick="showSection('appointments')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors admin-nav-btn">
                            <i class="fas fa-calendar mr-3"></i>Appointments
                        </button>
                    </li>
                    <li>
                        <button onclick="showSection('feedback')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors admin-nav-btn">
                            <i class="fas fa-comments mr-3"></i>Feedback
                        </button>
                    </li>
                    <li>
                        <button onclick="showSection('analytics')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors admin-nav-btn">
                            <i class="fas fa-chart-bar mr-3"></i>Analytics
                        </button>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content flex-1 p-4 md:p-6 md:ml-0">
            <!-- Dashboard Section -->
            <div id="dashboard" class="admin-section active">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Dashboard</h2>
                
                <!-- Stats Grid -->
                <div class="responsive-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
                        <div class="responsive-flex flex items-center">
                            <div class="bg-blue-100 p-3 rounded-full mb-2 md:mb-0">
                                <i class="fas fa-medkit text-blue-600 text-xl md:text-2xl"></i>
                            </div>
                            <div class="md:ml-4">
                                <h3 class="text-base md:text-lg font-semibold text-gray-700">Equipment Items</h3>
                                <p class="text-2xl md:text-3xl font-bold text-blue-600" id="equipmentCount">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
                        <div class="responsive-flex flex items-center">
                            <div class="bg-green-100 p-3 rounded-full mb-2 md:mb-0">
                                <i class="fas fa-pills text-green-600 text-xl md:text-2xl"></i>
                            </div>
                            <div class="md:ml-4">
                                <h3 class="text-base md:text-lg font-semibold text-gray-700">Medicine Types</h3>
                                <p class="text-2xl md:text-3xl font-bold text-green-600" id="medicineCount">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
                        <div class="responsive-flex flex items-center">
                            <div class="bg-purple-100 p-3 rounded-full mb-2 md:mb-0">
                                <i class="fas fa-blog text-purple-600 text-xl md:text-2xl"></i>
                            </div>
                            <div class="md:ml-4">
                                <h3 class="text-base md:text-lg font-semibold text-gray-700">Blog Posts</h3>
                                <p class="text-2xl md:text-3xl font-bold text-purple-600" id="blogCount">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
                        <div class="responsive-flex flex items-center">
                            <div class="bg-yellow-100 p-3 rounded-full mb-2 md:mb-0">
                                <i class="fas fa-calendar text-yellow-600 text-xl md:text-2xl"></i>
                            </div>
                            <div class="md:ml-4">
                                <h3 class="text-base md:text-lg font-semibold text-gray-700">Appointments</h3>
                                <p class="text-2xl md:text-3xl font-bold text-yellow-600" id="appointmentCount">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
                    <h3 class="text-lg md:text-xl font-semibold text-gray-800 mb-4">Recent Activity</h3>
                    <div id="recentActivity" class="space-y-3">
                        <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                            <i class="fas fa-info-circle text-blue-500 mr-3"></i>
                            <span class="text-gray-600 text-sm md:text-base">Welcome to NSG Health Admin Panel</span>
                            <span class="text-xs md:text-sm text-gray-400 ml-auto">Just now</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Equipment Management Section -->
            <div id="equipment" class="admin-section">
                <div class="responsive-flex flex justify-between items-center mb-6">
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Equipment Management</h2>
                    <button onclick="showAddEquipmentForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 md:px-4 py-2 rounded-lg transition-colors text-sm md:text-base">
                        <i class="fas fa-plus mr-1 md:mr-2"></i>Add Equipment
                    </button>
                </div>

                <!-- Add/Edit Equipment Form -->
                <div id="equipmentForm" class="bg-white rounded-lg shadow-md responsive-form p-4 md:p-6 mb-6 hidden">
                    <h3 class="text-lg md:text-xl font-semibold text-gray-800 mb-4" id="equipmentFormTitle">Add New Equipment</h3>
                    <form id="equipmentFormData">
                        <input type="hidden" id="equipmentId" name="id">
                        <div class="form-grid grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                            <div>
                                <label for="equipmentName" class="block text-gray-700 font-medium mb-2">Equipment Name</label>
                                <input type="text" id="equipmentName" name="name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label for="equipmentCategory" class="block text-gray-700 font-medium mb-2">Category</label>
                                <select id="equipmentCategory" name="category" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                    <option value="">Select Category</option>
                                    <option value="bandages">Bandages & Dressings</option>
                                    <option value="gloves">Gloves & Protection</option>
                                    <option value="syringes">Syringes & Needles</option>
                                    <option value="catheters">Catheters & Tubes</option>
                                    <option value="diagnostic">Diagnostic Tools</option>
                                    <option value="surgical">Surgical Supplies</option>
                                    <option value="lab">Lab Testing</option>
                                    <option value="protective">Protective Equipment</option>
                                    <option value="injection">Injection Supplies</option>
                                    <option value="monitors">Monitoring Devices</option>
                                    <option value="respiratory">Respiratory Care</option>
                                    <option value="mobility">Mobility Aids</option>
                                    <option value="general">General Medical</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label for="equipmentDescription" class="block text-gray-700 font-medium mb-2">Description</label>
                                <textarea id="equipmentDescription" name="description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required></textarea>
                            </div>
                            <div>
                                <label for="equipmentPrice" class="block text-gray-700 font-medium mb-2">Base Price (KSh)</label>
                                <input type="number" id="equipmentPrice" name="price" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label for="equipmentVariants" class="block text-gray-700 font-medium mb-2">Price Variants (Optional)</label>
                                <input type="text" id="equipmentVariants" name="variants" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Small - KSh 35, Large - KSh 50">
                                <p class="text-sm text-gray-500 mt-1">Comma-separated variants with prices</p>
                            </div>
                            <div class="md:col-span-2">
                                <label for="equipmentImage" class="block text-gray-700 font-medium mb-2">Equipment Image</label>
                                <input type="file" id="equipmentImage" name="image" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <p class="text-sm text-gray-500 mt-1">Upload an image file (JPG, PNG, etc.) - Max 5MB</p>
                                <div id="equipmentImagePreview" class="mt-2 hidden">
                                    <img id="equipmentPreviewImg" src="" alt="Preview" class="preview-image rounded border">
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-4 mt-6">
                            <button type="button" onclick="hideEquipmentForm()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">Cancel</button>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">Save Equipment</button>
                        </div>
                    </form>
                </div>

                <!-- Equipment List -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-4 md:p-6 border-b border-gray-200">
                        <h3 class="text-lg md:text-xl font-semibold text-gray-800">Current Equipment</h3>
                    </div>
                    <div id="equipmentList" class="divide-y divide-gray-200">
                        <!-- Equipment items will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Medicine Management Section -->
            <div id="medicine" class="admin-section">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Medicine Management</h2>
                    <button onclick="showAddMedicineForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-plus mr-2"></i>Add New Medicine
                    </button>
                </div>

                <!-- Add/Edit Medicine Form -->
                <div id="medicineForm" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4" id="medicineFormTitle">Add New Medicine</h3>
                    <form id="medicineFormData">
                        <input type="hidden" id="medicineId" name="id">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="medicineName" class="block text-gray-700 font-medium mb-2">Medicine Name</label>
                                <input type="text" id="medicineName" name="name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
                            </div>
                            <div>
                                <label for="medicineCategory" class="block text-gray-700 font-medium mb-2">Category</label>
                                <select id="medicineCategorySelect" name="category" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
                                    <option value="">Select Category</option>
                                    <option value="antibiotics">Antibiotics</option>
                                    <option value="painkillers">Pain Relief</option>
                                    <option value="vitamins">Vitamins & Supplements</option>
                                    <option value="diabetes">Diabetes Care</option>
                                    <option value="heart">Heart & Blood Pressure</option>
                                    <option value="respiratory">Respiratory</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label for="medicineDescription" class="block text-gray-700 font-medium mb-2">Description</label>
                                <textarea id="medicineDescription" name="description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required></textarea>
                            </div>
                            <div>
                                <label for="medicinePrice" class="block text-gray-700 font-medium mb-2">Price (KSh)</label>
                                <input type="number" id="medicinePrice" name="price" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
                            </div>
                            <div>
                                <label for="medicineStrength" class="block text-gray-700 font-medium mb-2">Strength/Dosage</label>
                                <input type="text" id="medicineStrength" name="strength" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="e.g., 500mg, 10ml">
                            </div>
                            <div>
                                <label for="medicineManufacturer" class="block text-gray-700 font-medium mb-2">Manufacturer</label>
                                <input type="text" id="medicineManufacturer" name="manufacturer" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="medicineImage" class="block text-gray-700 font-medium mb-2">Medicine Image</label>
                                <input type="file" id="medicineImage" name="image" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                                <p class="text-sm text-gray-500 mt-1">Upload an image file (JPG, PNG, etc.)</p>
                                <div id="medicineImagePreview" class="mt-2 hidden">
                                    <img id="medicinePreviewImg" src="" alt="Preview" class="preview-image rounded border">
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-4 mt-6">
                            <button type="button" onclick="hideMedicineForm()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">Cancel</button>
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">Save Medicine</button>
                        </div>
                    </form>
                </div>

                <!-- Medicine List -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-800">Current Medicine</h3>
                    </div>
                    <div id="medicineList" class="divide-y divide-gray-200">
                        <!-- Medicine items will be loaded here -->
                        <div class="p-6 text-center text-gray-500">
                            <i class="fas fa-pills text-4xl mb-2"></i>
                            <p>No medicine added yet. Click "Add New Medicine" to get started.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Blog Management Section -->
            <div id="blogs" class="admin-section">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Blog Management</h2>
                    <button onclick="showAddBlogForm()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-plus mr-2"></i>Add New Blog Post
                    </button>
                </div>

                <!-- Add/Edit Blog Form -->
                <div id="blogForm" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4" id="blogFormTitle">Add New Blog Post</h3>
                    <form id="blogFormData">
                        <input type="hidden" id="blogId" name="id">
                        <div class="space-y-6">
                            <div>
                                <label for="blogTitle" class="block text-gray-700 font-medium mb-2">Blog Title</label>
                                <input type="text" id="blogTitle" name="title" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                            </div>
                            <div>
                                <label for="blogAuthor" class="block text-gray-700 font-medium mb-2">Author</label>
                                <input type="text" id="blogAuthor" name="author" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                            </div>
                            <div>
                                <label for="blogExcerpt" class="block text-gray-700 font-medium mb-2">Excerpt</label>
                                <textarea id="blogExcerpt" name="excerpt" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Brief description of the blog post" required></textarea>
                            </div>
                            <div>
                                <label for="blogContent" class="block text-gray-700 font-medium mb-2">Content</label>
                                <textarea id="blogContent" name="content" rows="10" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" required></textarea>
                            </div>
                            <div>
                                <label for="blogImage" class="block text-gray-700 font-medium mb-2">Featured Image</label>
                                <input type="file" id="blogImage" name="image" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <p class="text-sm text-gray-500 mt-1">Upload a featured image for the blog post</p>
                                <div id="blogImagePreview" class="mt-2 hidden">
                                    <img id="blogPreviewImg" src="" alt="Preview" class="preview-image rounded border">
                                </div>
                            </div>
                            <div>
                                <label for="blogTags" class="block text-gray-700 font-medium mb-2">Tags (comma-separated)</label>
                                <input type="text" id="blogTags" name="tags" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="health, medicine, wellness">
                            </div>
                        </div>
                        <div class="flex justify-end space-x-4 mt-6">
                            <button type="button" onclick="hideBlogForm()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">Cancel</button>
                            <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">Publish Blog Post</button>
                        </div>
                    </form>
                </div>

                <!-- Blog List -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-800">Published Blog Posts</h3>
                    </div>
                    <div id="blogList" class="divide-y divide-gray-200">
                        <!-- Blog posts will be loaded here -->
                        <div class="p-6 text-center text-gray-500">
                            <i class="fas fa-blog text-4xl mb-2"></i>
                            <p>No blog posts published yet. Click "Add New Blog Post" to get started.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Appointments Section -->
            <div id="appointments" class="admin-section">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Appointment Management</h2>
                
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-800">Recent Appointments</h3>
                    </div>
                    <div id="appointmentsList" class="divide-y divide-gray-200">
                        <div class="p-6 text-center text-gray-500">
                            <i class="fas fa-calendar text-4xl mb-2"></i>
                            <p>No appointments yet. Appointments will appear here when patients book through the website.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feedback Section -->
            <div id="feedback" class="admin-section">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Customer Feedback</h2>
                
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-800">Recent Feedback</h3>
                    </div>
                    <div id="feedbackList" class="divide-y divide-gray-200">
                        <div class="p-6 text-center text-gray-500">
                            <i class="fas fa-comments text-4xl mb-2"></i>
                            <p>No feedback yet. Customer feedback will appear here when submitted through the website.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div id="analytics" class="admin-section">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Analytics & Reports</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
                        <h3 class="text-lg md:text-xl font-semibold text-gray-800 mb-4">Real-Time Equipment Status</h3>
                        <div id="equipmentAnalytics" class="space-y-3">
                            <div class="text-center text-gray-500 py-4">
                                <i class="fas fa-chart-line text-3xl mb-2"></i>
                                <p class="text-sm">Analytics will update based on actual orders</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
                        <h3 class="text-lg md:text-xl font-semibold text-gray-800 mb-4">Website Activity</h3>
                        <div id="websiteAnalytics" class="space-y-3">
                            <div class="text-center text-gray-500 py-4">
                                <i class="fas fa-globe text-3xl mb-2"></i>
                                <p class="text-sm">Real visitor data will appear here</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Real Analytics Data -->
                <div class="mt-8 bg-white rounded-lg shadow-md p-4 md:p-6">
                    <h3 class="text-lg md:text-xl font-semibold text-gray-800 mb-4">Current System Status</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-600 text-2xl mr-3"></i>
                                <div>
                                    <h4 class="font-semibold text-green-800">System Online</h4>
                                    <p class="text-green-600 text-sm">All services operational</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-sync-alt text-blue-600 text-2xl mr-3"></i>
                                <div>
                                    <h4 class="font-semibold text-blue-800">Real-time Sync</h4>
                                    <p class="text-blue-600 text-sm">Active and running</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-database text-purple-600 text-2xl mr-3"></i>
                                <div>
                                    <h4 class="font-semibold text-purple-800">Data Storage</h4>
                                    <p class="text-purple-600 text-sm">Local & synchronized</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Admin user credentials - in production, this should be server-side
        const adminUsers = {
            'admin': { password: '1a2d3m4i5n', role: 'admin', name: 'NSG Health Administrator' },
            'nsg': { password: 'health2024', role: 'admin', name: 'NSG Health Admin' }
        };

        // Session management variables
        let sessionTimer = null;
        let warningTimer = null;
        let sessionExpireTime = null;
        const SESSION_DURATION = 60 * 60 * 1000; // 1 hour in milliseconds
        const WARNING_TIME = 5 * 60 * 1000; // 5 minutes warning

        // Check if all required functions are available
        function checkFunctionAvailability() {
            const requiredFunctions = [
                'showNotification', 'logActivity', 'loadData', 'updateCounts', 
                'initializeMobileMenu', 'setupImagePreviewHandlers'
            ];
            
            const missingFunctions = [];
            requiredFunctions.forEach(funcName => {
                if (typeof window[funcName] !== 'function') {
                    missingFunctions.push(funcName);
                }
            });
            
            if (missingFunctions.length > 0) {
                console.log('Missing functions:', missingFunctions);
                return false;
            }
            return true;
        }

        // Authentication check - now modal-based
        function checkAuthentication() {
            const session = localStorage.getItem('nsg_admin_session');
            
            if (!session) {
                showAuthModal();
                return false;
            }
            
            const sessionData = JSON.parse(session);
            const loginTime = new Date(sessionData.loginTime);
            const now = new Date();
            const timeDiff = now - loginTime;
            
            // Check if session is expired (1 hour for regular login, unlimited for remember me)
            if (!sessionData.rememberMe && timeDiff > SESSION_DURATION) {
                localStorage.removeItem('nsg_admin_session');
                showAuthModal();
                showNotification('Session expired. Please log in again.', 'error');
                return false;
            }
            
            // If we get here, authentication is valid
            hideAuthModal();
            
            // Update welcome message
            document.getElementById('currentUser').textContent = `Welcome, ${sessionData.name}`;
            
            // Start session monitoring if not remember me
            if (!sessionData.rememberMe) {
                startSessionMonitoring(sessionData);
            }
            
            return true;
        }

        // Show authentication modal
        function showAuthModal() {
            document.getElementById('authModal').style.display = 'flex';
            document.getElementById('adminContent').classList.remove('authenticated');
            // Focus on username field
            setTimeout(() => {
                document.getElementById('modalUsername').focus();
            }, 300);
        }

        // Hide authentication modal
        function hideAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            document.getElementById('adminContent').classList.add('authenticated');
        }

        // Session monitoring
        function startSessionMonitoring(sessionData) {
            const loginTime = new Date(sessionData.loginTime);
            sessionExpireTime = new Date(loginTime.getTime() + SESSION_DURATION);
            
            // Update timer display
            updateSessionTimer();
            sessionTimer = setInterval(updateSessionTimer, 1000);
            
            // Set warning timer
            const warningTime = new Date(loginTime.getTime() + SESSION_DURATION - WARNING_TIME);
            const timeToWarning = warningTime - new Date();
            
            if (timeToWarning > 0) {
                warningTimer = setTimeout(showSessionWarning, timeToWarning);
            }
        }

        // Update session timer display
        function updateSessionTimer() {
            const now = new Date();
            const timeLeft = sessionExpireTime - now;
            
            if (timeLeft <= 0) {
                forceLogout();
                return;
            }
            
            const minutes = Math.floor(timeLeft / 60000);
            const seconds = Math.floor((timeLeft % 60000) / 1000);
            
            const timerElement = document.getElementById('timeRemaining');
            if (timerElement) {
                timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('sessionTimer').classList.remove('hidden');
            }
        }

        // Show session warning
        function showSessionWarning() {
            document.getElementById('sessionWarning').style.display = 'block';
            
            let countdown = 5;
            const warningInterval = setInterval(() => {
                document.getElementById('warningTime').textContent = countdown;
                countdown--;
                
                if (countdown < 0) {
                    clearInterval(warningInterval);
                    forceLogout();
                }
            }, 60000); // Update every minute
        }

        // Extend session
        function extendSession() {
            const session = localStorage.getItem('nsg_admin_session');
            if (session) {
                const sessionData = JSON.parse(session);
                sessionData.loginTime = new Date().toISOString();
                localStorage.setItem('nsg_admin_session', JSON.stringify(sessionData));
                
                // Restart session monitoring
                clearTimeout(warningTimer);
                clearInterval(sessionTimer);
                startSessionMonitoring(sessionData);
                
                // Hide warning
                document.getElementById('sessionWarning').style.display = 'none';
                
                showNotification('Session extended successfully', 'info');
                logActivity('session_extend');
            }
        }

        // Force logout
        function forceLogout() {
            clearTimeout(warningTimer);
            clearInterval(sessionTimer);
            localStorage.removeItem('nsg_admin_session');
            document.getElementById('sessionWarning').style.display = 'none';
            showAuthModal();
            showNotification('Session expired. Please log in again.', 'error');
            logActivity('session_expired');
        }

        // Modal login form handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Toggle password visibility in modal
            document.getElementById('modalTogglePassword').addEventListener('click', function() {
                const passwordInput = document.getElementById('modalPassword');
                const icon = this.querySelector('i');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });

            // Modal login form submission
            document.getElementById('modalLoginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const username = document.getElementById('modalUsername').value.toLowerCase();
                const password = document.getElementById('modalPassword').value;
                const rememberMe = document.getElementById('modalRememberMe').checked;
                
                // Show loading state
                document.getElementById('authLoading').style.display = 'flex';
                
                // Simulate authentication delay for security
                setTimeout(() => {
                    if (adminUsers[username] && adminUsers[username].password === password) {
                        // Store session
                        const sessionData = {
                            username: username,
                            role: adminUsers[username].role,
                            name: adminUsers[username].name,
                            loginTime: new Date().toISOString(),
                            rememberMe: rememberMe
                        };
                        
                        localStorage.setItem('nsg_admin_session', JSON.stringify(sessionData));
                        
                        // Log the login activity
                        setTimeout(() => {
                            try {
                                logActivity('login', {
                                    user: adminUsers[username].name,
                                    role: adminUsers[username].role
                                });
                            } catch(e) {
                                console.log('Activity logging not ready yet');
                            }
                        }, 100);
                        
                        // Hide loading and authenticate
                        document.getElementById('authLoading').style.display = 'none';
                        
                        // Successfully authenticate and show admin content
                        console.log('Authentication successful, hiding modal and showing admin content');
                        hideAuthModal();
                        document.getElementById('currentUser').textContent = `Welcome, ${sessionData.name}`;
                        
                        // Initialize admin panel functionality
                        setTimeout(() => {
                            console.log('Starting admin panel initialization...');
                            try {
                                initializeAdminPanel();
                                console.log('Admin panel initialization completed successfully');
                            } catch(e) {
                                console.log('Admin panel initialization error:', e);
                                // Try basic initialization
                                document.getElementById('adminContent').classList.add('authenticated');
                                loadData();
                                updateCounts();
                                console.log('Basic initialization completed as fallback');
                            }
                        }, 200);
                        
                        // Clear form
                        document.getElementById('modalLoginForm').reset();
                        
                        showNotification('Login successful! Welcome to NSG Health Admin.', 'success');
                    } else {
                        document.getElementById('authLoading').style.display = 'none';
                        showModalError('Invalid username or password. Please try again.');
                    }
                }, 1000);
            });

            // Show modal error
            function showModalError(message) {
                const errorDiv = document.getElementById('modalErrorMessage');
                const errorText = document.getElementById('modalErrorText');
                const form = document.getElementById('modalLoginForm');
                
                errorText.textContent = message;
                errorDiv.classList.remove('hidden');
                form.classList.add('shake');
                
                setTimeout(() => {
                    form.classList.remove('shake');
                }, 500);
                
                setTimeout(() => {
                    errorDiv.classList.add('hidden');
                }, 5000);
            }

            // Prevent modal close on escape or outside click
            document.getElementById('authModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    // Don't close modal - force authentication
                    showNotification('Authentication required to access admin panel', 'error');
                }
            });

            // Prevent escape key from closing modal
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && document.getElementById('authModal').style.display === 'flex') {
                    e.preventDefault();
                    showNotification('Authentication required to access admin panel', 'error');
                }
            });

            // Additional security: prevent console bypass attempts
            Object.defineProperty(window, 'hideAuthModal', {
                value: function() {
                    if (!checkAuthentication()) {
                        showNotification('Unauthorized access attempt detected', 'error');
                        return false;
                    }
                    return hideAuthModal();
                },
                writable: false,
                configurable: false
            });

            // Prevent direct access to admin functions without authentication
            const originalShowSection = window.showSection;
            window.showSection = function(...args) {
                if (!checkAuthentication()) {
                    showNotification('Please authenticate to access admin functions', 'error');
                    return false;
                }
                return originalShowSection.apply(this, args);
            };

            // Monitor for authentication bypass attempts
            setInterval(function() {
                const authModal = document.getElementById('authModal');
                const adminContent = document.getElementById('adminContent');
                
                if (authModal.style.display !== 'flex' && !adminContent.classList.contains('authenticated')) {
                    // Potential bypass detected
                    console.warn('Authentication bypass attempt detected');
                    showAuthModal();
                }
            }, 2000);

            // Initial authentication check
            setTimeout(() => {
                const isAuthenticated = checkAuthentication();
                console.log('Initial authentication check:', isAuthenticated);
                
                if (isAuthenticated) {
                    // User is already authenticated, initialize admin panel
                    setTimeout(() => {
                        try {
                            initializeAdminPanel();
                        } catch(e) {
                            console.log('Error in initializeAdminPanel:', e);
                            basicInitialization();
                        }
                    }, 100);
                }
            }, 500);
        });

        // Initialize admin panel functionality
        function initializeAdminPanel() {
            try {
                // Initialize mobile menu
                initializeMobileMenu();
                
                // Initialize real-time sync
                realTimeSync = new RealTimeSync();
                
                // Load and initialize data
                initializeCompleteData();
                
                // Setup image preview handlers
                setupImagePreviewHandlers();
                
                // Log the session start activity
                logActivity('session_start');
            } catch(error) {
                console.log('Error in full initialization, using basic mode:', error);
                // Basic fallback initialization
                basicInitialization();
            }
        }

        // Basic fallback initialization
        function basicInitialization() {
            try {
                // Ensure admin content is shown
                document.getElementById('adminContent').classList.add('authenticated');
                
                // Initialize mobile menu if function exists
                if (typeof initializeMobileMenu === 'function') {
                    initializeMobileMenu();
                }
                
                // Load data if function exists
                if (typeof loadData === 'function') {
                    loadData();
                }
                
                // Update counts if function exists
                if (typeof updateCounts === 'function') {
                    updateCounts();
                }
                
                // Setup basic image preview if function exists
                if (typeof setupImagePreviewHandlers === 'function') {
                    setupImagePreviewHandlers();
                }
                
                console.log('Basic admin panel initialization completed');
            } catch(e) {
                console.log('Even basic initialization failed:', e);
                // Absolute minimum - just show the admin content
                document.getElementById('adminContent').classList.add('authenticated');
            }
        }

        // Page visibility change handler - pause timers when tab is hidden
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                if (sessionTimer) clearInterval(sessionTimer);
            } else {
                // Recheck authentication when tab becomes visible
                const session = localStorage.getItem('nsg_admin_session');
                if (session) {
                    const sessionData = JSON.parse(session);
                    if (!sessionData.rememberMe) {
                        const loginTime = new Date(sessionData.loginTime);
                        const now = new Date();
                        const timeDiff = now - loginTime;
                        
                        if (timeDiff > SESSION_DURATION) {
                            forceLogout();
                        } else {
                            startSessionMonitoring(sessionData);
                        }
                    }
                }
            }
        });

        // Update logout function to work with modal
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Log the logout activity
                logActivity('logout');
                
                // Clear timers
                clearTimeout(warningTimer);
                clearInterval(sessionTimer);
                
                // Clear session data
                localStorage.removeItem('nsg_admin_session');
                
                // Show modal again
                showAuthModal();
                
                showNotification('Logged out successfully', 'info');
            }
        }

        // Real-time communication system
        class RealTimeSync {
            constructor() {
                this.isActive = true;
                this.lastUpdate = Date.now();
                this.syncEvents = ['equipment', 'medicine', 'blogs', 'appointments', 'feedback'];
                this.setupStorageListener();
                this.startHeartbeat();
            }

            setupStorageListener() {
                // Listen for changes from the frontend
                window.addEventListener('storage', (e) => {
                    if (e.key && e.key.startsWith('nsg_')) {
                        this.handleExternalChange(e.key, e.newValue);
                    }
                });

                // Listen for changes within the same tab
                this.originalSetItem = Storage.prototype.setItem;
                Storage.prototype.setItem = (key, value) => {
                    const oldValue = localStorage.getItem(key);
                    this.originalSetItem.call(localStorage, key, value);
                    
                    if (key.startsWith('nsg_') && oldValue !== value) {
                        this.broadcastChange(key, value);
                    }
                };
            }

            handleExternalChange(key, newValue) {
                console.log('External change detected:', key);
                
                if (key === 'nsg_equipment' && newValue) {
                    equipmentData = JSON.parse(newValue);
                    updateEquipmentList();
                    updateCounts();
                    showNotification('Equipment updated from frontend', 'info');
                }
                
                if (key === 'nsg_medicine' && newValue) {
                    medicineData = JSON.parse(newValue);
                    updateMedicineList();
                    updateCounts();
                    showNotification('Medicine updated from frontend', 'info');
                }
                
                if (key === 'nsg_blogs' && newValue) {
                    blogData = JSON.parse(newValue);
                    updateBlogList();
                    updateCounts();
                    showNotification('Blogs updated from frontend', 'info');
                }

                if (key === 'nsg_frontend_activity') {
                    this.handleFrontendActivity(JSON.parse(newValue));
                }
            }

            broadcastChange(key, value) {
                // Trigger custom event for real-time updates
                const changeEvent = new CustomEvent('nsgDataChange', {
                    detail: { key, value, timestamp: Date.now() }
                });
                window.dispatchEvent(changeEvent);
                
                // Update sync indicator
                this.updateSyncIndicator();
            }

            handleFrontendActivity(activity) {
                // Handle activities from frontend (appointments, feedback, etc.)
                const activities = JSON.parse(localStorage.getItem('nsg_admin_activities') || '[]');
                activities.unshift({
                    ...activity,
                    timestamp: new Date().toISOString(),
                    source: 'frontend'
                });
                
                if (activities.length > 100) activities.splice(100);
                localStorage.setItem('nsg_admin_activities', JSON.stringify(activities));
                
                // Update dashboard
                updateRecentActivity();
                showNotification(`New ${activity.type} from website`, 'info');
            }

            updateSyncIndicator() {
                const indicator = document.getElementById('realTimeStatus');
                indicator.classList.add('status-online');
                indicator.innerHTML = '<span class="status-indicator status-online"></span>Data synced';
                
                setTimeout(() => {
                    indicator.innerHTML = '<span class="status-indicator status-online"></span>Real-time sync active';
                }, 2000);
            }

            startHeartbeat() {
                setInterval(() => {
                    // Send heartbeat to indicate admin is active
                    localStorage.setItem('nsg_admin_heartbeat', Date.now().toString());
                }, 5000);
            }
        }

        // Global data storage
        let equipmentData = [];
        let medicineData = [];
        let blogData = [];
        let appointmentsData = [];
        let feedbackData = [];
        let realTimeSync;

        // Notification system
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            
            // Set color based on type
            notification.className = `notification px-6 py-3 rounded-lg shadow-lg ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                type === 'info' ? 'bg-blue-500' : 'bg-gray-500'
            } text-white`;
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Navigation
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.admin-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Update navigation
            document.querySelectorAll('.admin-nav-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-100', 'text-blue-600');
            });
            event.target.classList.add('active', 'bg-blue-100', 'text-blue-600');
        }

        // Equipment Management
        function showAddEquipmentForm() {
            document.getElementById('equipmentForm').classList.remove('hidden');
            document.getElementById('equipmentFormTitle').textContent = 'Add New Equipment';
            document.getElementById('equipmentFormData').reset();
            document.getElementById('equipmentId').value = '';
        }

        function hideEquipmentForm() {
            document.getElementById('equipmentForm').classList.add('hidden');
        }

        function editEquipment(id) {
            const equipment = equipmentData.find(item => item.id === id);
            if (equipment) {
                document.getElementById('equipmentForm').classList.remove('hidden');
                document.getElementById('equipmentFormTitle').textContent = 'Edit Equipment';
                document.getElementById('equipmentId').value = equipment.id;
                document.getElementById('equipmentName').value = equipment.name;
                document.getElementById('equipmentCategory').value = equipment.category;
                document.getElementById('equipmentDescription').value = equipment.description;
                document.getElementById('equipmentPrice').value = equipment.price;
                document.getElementById('equipmentImage').value = equipment.image || '';
            }
        }

        function deleteEquipment(id) {
            if (confirm('Are you sure you want to delete this equipment?')) {
                const equipment = equipmentData.find(item => item.id === id);
                equipmentData = equipmentData.filter(item => item.id !== id);
                updateEquipmentList();
                updateCounts();
                showNotification('Equipment deleted successfully');
                logActivity('equipment_delete', { name: equipment?.name });
                syncToFrontend();
            }
        }

        function updateEquipmentList() {
            const equipmentList = document.getElementById('equipmentList');
            
            if (equipmentData.length === 0) {
                equipmentList.innerHTML = `
                    <div class="p-6 text-center text-gray-500">
                        <i class="fas fa-medkit text-4xl mb-2"></i>
                        <p>No equipment added yet. Click "Add New Equipment" to get started.</p>
                    </div>
                `;
                return;
            }
            
            equipmentList.innerHTML = equipmentData.map(equipment => `
                <div class="p-6 flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        ${equipment.image ? 
                            `<img src="${equipment.image}" alt="${equipment.name}" class="w-16 h-16 object-cover rounded-lg">` :
                            `<div class="w-16 h-16 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-medkit text-blue-600 text-2xl"></i>
                            </div>`
                        }
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800">${equipment.name}</h4>
                            <p class="text-gray-600">${equipment.description}</p>
                            <p class="text-blue-600 font-semibold">KSh ${equipment.price}</p>
                            <span class="text-sm text-gray-500 bg-gray-100 px-2 py-1 rounded">${equipment.category}</span>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editEquipment('${equipment.id}')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteEquipment('${equipment.id}')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Medicine Management
        function showAddMedicineForm() {
            document.getElementById('medicineForm').classList.remove('hidden');
            document.getElementById('medicineFormTitle').textContent = 'Add New Medicine';
            document.getElementById('medicineFormData').reset();
            document.getElementById('medicineId').value = '';
        }

        function hideMedicineForm() {
            document.getElementById('medicineForm').classList.add('hidden');
        }

        function editMedicine(id) {
            const medicine = medicineData.find(item => item.id === id);
            if (medicine) {
                document.getElementById('medicineForm').classList.remove('hidden');
                document.getElementById('medicineFormTitle').textContent = 'Edit Medicine';
                document.getElementById('medicineId').value = medicine.id;
                document.getElementById('medicineName').value = medicine.name;
                document.getElementById('medicineCategorySelect').value = medicine.category;
                document.getElementById('medicineDescription').value = medicine.description;
                document.getElementById('medicinePrice').value = medicine.price;
                document.getElementById('medicineStrength').value = medicine.strength || '';
                document.getElementById('medicineManufacturer').value = medicine.manufacturer || '';
                document.getElementById('medicineImage').value = medicine.image || '';
            }
        }

        function deleteMedicine(id) {
            if (confirm('Are you sure you want to delete this medicine?')) {
                const medicine = medicineData.find(item => item.id === id);
                medicineData = medicineData.filter(item => item.id !== id);
                updateMedicineList();
                updateCounts();
                showNotification('Medicine deleted successfully');
                logActivity('medicine_delete', { name: medicine?.name });
                syncToFrontend();
            }
        }

        function updateMedicineList() {
            const medicineList = document.getElementById('medicineList');
            
            if (medicineData.length === 0) {
                medicineList.innerHTML = `
                    <div class="p-6 text-center text-gray-500">
                        <i class="fas fa-pills text-4xl mb-2"></i>
                        <p>No medicine added yet. Click "Add New Medicine" to get started.</p>
                    </div>
                `;
                return;
            }
            
            medicineList.innerHTML = medicineData.map(medicine => `
                <div class="p-6 flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        ${medicine.image ? 
                            `<img src="${medicine.image}" alt="${medicine.name}" class="w-16 h-16 object-cover rounded-lg">` :
                            `<div class="w-16 h-16 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-pills text-green-600 text-2xl"></i>
                            </div>`
                        }
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800">${medicine.name}</h4>
                            <p class="text-gray-600">${medicine.description}</p>
                            <p class="text-green-600 font-semibold">KSh ${medicine.price}</p>
                            <div class="flex space-x-2 mt-1">
                                <span class="text-sm text-gray-500 bg-gray-100 px-2 py-1 rounded">${medicine.category}</span>
                                ${medicine.strength ? `<span class="text-sm text-gray-500 bg-blue-100 px-2 py-1 rounded">${medicine.strength}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editMedicine('${medicine.id}')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteMedicine('${medicine.id}')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Blog Management
        function showAddBlogForm() {
            document.getElementById('blogForm').classList.remove('hidden');
            document.getElementById('blogFormTitle').textContent = 'Add New Blog Post';
            document.getElementById('blogFormData').reset();
            document.getElementById('blogId').value = '';
        }

        function hideBlogForm() {
            document.getElementById('blogForm').classList.add('hidden');
        }

        function editBlog(id) {
            const blog = blogData.find(item => item.id === id);
            if (blog) {
                document.getElementById('blogForm').classList.remove('hidden');
                document.getElementById('blogFormTitle').textContent = 'Edit Blog Post';
                document.getElementById('blogId').value = blog.id;
                document.getElementById('blogTitle').value = blog.title;
                document.getElementById('blogAuthor').value = blog.author;
                document.getElementById('blogExcerpt').value = blog.excerpt;
                document.getElementById('blogContent').value = blog.content;
                document.getElementById('blogImage').value = blog.image || '';
                document.getElementById('blogTags').value = blog.tags ? blog.tags.join(', ') : '';
            }
        }

        function deleteBlog(id) {
            if (confirm('Are you sure you want to delete this blog post?')) {
                const blog = blogData.find(item => item.id === id);
                blogData = blogData.filter(item => item.id !== id);
                updateBlogList();
                updateCounts();
                showNotification('Blog post deleted successfully');
                logActivity('blog_delete', { title: blog?.title });
                syncToFrontend();
            }
        }

        function updateBlogList() {
            const blogList = document.getElementById('blogList');
            
            if (blogData.length === 0) {
                blogList.innerHTML = `
                    <div class="p-6 text-center text-gray-500">
                        <i class="fas fa-blog text-4xl mb-2"></i>
                        <p>No blog posts published yet. Click "Add New Blog Post" to get started.</p>
                    </div>
                `;
                return;
            }
            
            blogList.innerHTML = blogData.map(blog => `
                <div class="p-6 flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        ${blog.image ? 
                            `<img src="${blog.image}" alt="${blog.title}" class="w-16 h-16 object-cover rounded-lg">` :
                            `<div class="w-16 h-16 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-blog text-purple-600 text-2xl"></i>
                            </div>`
                        }
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800">${blog.title}</h4>
                            <p class="text-gray-600 text-sm">${blog.excerpt}</p>
                            <p class="text-sm text-gray-500">By ${blog.author}  ${new Date(blog.publishedAt).toLocaleDateString()}</p>
                            ${blog.tags && blog.tags.length > 0 ? 
                                `<div class="flex space-x-1 mt-2">
                                    ${blog.tags.map(tag => `<span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">${tag}</span>`).join('')}
                                </div>` : ''
                            }
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editBlog('${blog.id}')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteBlog('${blog.id}')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Mobile menu functionality
        function initializeMobileMenu() {
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const sidebar = document.getElementById('sidebar');
            const mobileOverlay = document.getElementById('mobileOverlay');
            
            if (mobileMenuBtn && sidebar && mobileOverlay) {
                mobileMenuBtn.addEventListener('click', function() {
                    sidebar.classList.add('mobile-open');
                    mobileOverlay.classList.add('active');
                });
                
                mobileOverlay.addEventListener('click', function() {
                    sidebar.classList.remove('mobile-open');
                    mobileOverlay.classList.remove('active');
                });
                
                // Close sidebar when clicking nav items on mobile
                document.querySelectorAll('.admin-nav-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        if (window.innerWidth < 768) {
                            sidebar.classList.remove('mobile-open');
                            mobileOverlay.classList.remove('active');
                        }
                    });
                });
            }
        }

        // Equipment form submission handler with variants support
        document.getElementById('equipmentFormData').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const imageFile = formData.get('image');
            let imageData = '';
            
            // Handle image file upload
            if (imageFile && imageFile.size > 0) {
                try {
                    imageData = await fileToBase64(imageFile);
                } catch (error) {
                    showNotification('Error processing image file', 'error');
                    return;
                }
            }
            
            const equipmentItem = {
                id: formData.get('id') || Date.now().toString(),
                name: formData.get('name'),
                category: formData.get('category'),
                description: formData.get('description'),
                price: formData.get('price'),
                variants: formData.get('variants') || '',
                image: imageData
            };
            
            if (formData.get('id')) {
                // Edit existing
                const index = equipmentData.findIndex(item => item.id === formData.get('id'));
                if (index !== -1) {
                    // Preserve existing image if no new image uploaded
                    if (!imageData && equipmentData[index].image) {
                        equipmentItem.image = equipmentData[index].image;
                    }
                    equipmentData[index] = equipmentItem;
                    showNotification('Equipment updated successfully');
                    logActivity('equipment_edit', { name: equipmentItem.name });
                }
            } else {
                // Add new
                equipmentData.push(equipmentItem);
                showNotification('Equipment added successfully');
                logActivity('equipment_add', { name: equipmentItem.name });
            }
            
            updateEquipmentList();
            updateCounts();
            hideEquipmentForm();
            syncToFrontend();
        });

        document.getElementById('medicineFormData').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const imageFile = formData.get('image');
            let imageData = '';
            
            // Handle image file upload
            if (imageFile && imageFile.size > 0) {
                try {
                    imageData = await fileToBase64(imageFile);
                } catch (error) {
                    showNotification('Error processing image file', 'error');
                    return;
                }
            }
            
            const medicineItem = {
                id: formData.get('id') || Date.now().toString(),
                name: formData.get('name'),
                category: formData.get('category'),
                description: formData.get('description'),
                price: formData.get('price'),
                strength: formData.get('strength'),
                manufacturer: formData.get('manufacturer'),
                image: imageData
            };
            
            if (formData.get('id')) {
                // Edit existing
                const index = medicineData.findIndex(item => item.id === formData.get('id'));
                medicineData[index] = medicineItem;
                showNotification('Medicine updated successfully');
                logActivity('medicine_edit', { name: medicineItem.name });
            } else {
                // Add new
                medicineData.push(medicineItem);
                showNotification('Medicine added successfully');
                logActivity('medicine_add', { name: medicineItem.name });
            }
            
            updateMedicineList();
            updateCounts();
            hideMedicineForm();
            syncToFrontend();
        });

        document.getElementById('blogFormData').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const imageFile = formData.get('image');
            let imageData = '';
            
            // Handle image file upload
            if (imageFile && imageFile.size > 0) {
                try {
                    imageData = await fileToBase64(imageFile);
                } catch (error) {
                    showNotification('Error processing image file', 'error');
                    return;
                }
            }
            
            const blogItem = {
                id: formData.get('id') || Date.now().toString(),
                title: formData.get('title'),
                author: formData.get('author'),
                excerpt: formData.get('excerpt'),
                content: formData.get('content'),
                image: imageData,
                tags: formData.get('tags') ? formData.get('tags').split(',').map(tag => tag.trim()) : [],
                publishedAt: formData.get('id') ? blogData.find(b => b.id === formData.get('id')).publishedAt : new Date().toISOString()
            };
            
            if (formData.get('id')) {
                // Edit existing
                const index = blogData.findIndex(item => item.id === formData.get('id'));
                blogData[index] = blogItem;
                showNotification('Blog post updated successfully');
                logActivity('blog_edit', { title: blogItem.title });
            } else {
                // Add new
                blogData.push(blogItem);
                showNotification('Blog post published successfully');
                logActivity('blog_add', { title: blogItem.title });
            }
            
            updateBlogList();
            updateCounts();
            hideBlogForm();
            syncToFrontend();
        });

        // Update counts with real data
        function updateCounts() {
            document.getElementById('equipmentCount').textContent = equipmentData.length;
            document.getElementById('medicineCount').textContent = medicineData.length;
            document.getElementById('blogCount').textContent = blogData.length;
            document.getElementById('appointmentCount').textContent = appointmentsData.length;
            
            // Update real analytics
            updateRealAnalytics();
        }

        // Update analytics with real data
        function updateRealAnalytics() {
            const activities = JSON.parse(localStorage.getItem('nsg_admin_activities') || '[]');
            const orders = activities.filter(a => a.type === 'order');
            
            // Update equipment analytics
            const equipmentAnalytics = document.getElementById('equipmentAnalytics');
            if (orders.length > 0) {
                const orderCounts = {};
                orders.forEach(order => {
                    orderCounts[order.product] = (orderCounts[order.product] || 0) + 1;
                });
                
                const sortedOrders = Object.entries(orderCounts)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5);
                
                equipmentAnalytics.innerHTML = sortedOrders.map(([product, count]) => `
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600 text-sm">${product}</span>
                        <span class="text-blue-600 font-semibold">${count} order${count > 1 ? 's' : ''}</span>
                    </div>
                `).join('');
            } else {
                equipmentAnalytics.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <i class="fas fa-chart-line text-3xl mb-2"></i>
                        <p class="text-sm">No orders yet - analytics will update with real data</p>
                    </div>
                `;
            }
            
            // Update website analytics
            const websiteAnalytics = document.getElementById('websiteAnalytics');
            const totalActivities = activities.length;
            const frontendActivities = activities.filter(a => a.source === 'frontend').length;
            
            if (totalActivities > 0) {
                websiteAnalytics.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600 text-sm">Total Activities</span>
                        <span class="text-green-600 font-semibold">${totalActivities}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600 text-sm">Website Interactions</span>
                        <span class="text-green-600 font-semibold">${frontendActivities}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600 text-sm">Admin Actions</span>
                        <span class="text-green-600 font-semibold">${totalActivities - frontendActivities}</span>
                    </div>
                `;
            } else {
                websiteAnalytics.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <i class="fas fa-globe text-3xl mb-2"></i>
                        <p class="text-sm">No website activity yet</p>
                    </div>
                `;
            }
        }

        // Enhanced sync data to frontend (real-time updates)
        function syncToFrontend() {
            // Store data with timestamp for versioning
            const timestamp = Date.now();
            
            localStorage.setItem('nsg_equipment', JSON.stringify(equipmentData));
            localStorage.setItem('nsg_medicine', JSON.stringify(medicineData));
            localStorage.setItem('nsg_blogs', JSON.stringify(blogData));
            localStorage.setItem('nsg_last_update', timestamp.toString());
            
            // Trigger storage event for cross-tab communication
            window.dispatchEvent(new StorageEvent('storage', {
                key: 'nsg_last_update',
                newValue: timestamp.toString(),
                url: window.location.href
            }));
            
            console.log('Data synced to frontend:', {
                equipment: equipmentData.length,
                medicine: medicineData.length,
                blogs: blogData.length,
                timestamp: new Date(timestamp).toLocaleString()
            });
        }

        // Enhanced load data with real-time updates
        function loadData() {
            console.log('Loading data...');
            
            const storedEquipment = localStorage.getItem('nsg_equipment');
            const storedMedicine = localStorage.getItem('nsg_medicine');
            const storedBlogs = localStorage.getItem('nsg_blogs');
            
            console.log('Stored equipment:', storedEquipment);
            
            if (storedEquipment) {
                equipmentData = JSON.parse(storedEquipment);
                console.log('Loaded equipment data:', equipmentData.length, 'items');
                updateEquipmentList();
            } else {
                console.log('No stored equipment found');
            }
            
            if (storedMedicine) {
                medicineData = JSON.parse(storedMedicine);
                updateMedicineList();
            }
            
            if (storedBlogs) {
                blogData = JSON.parse(storedBlogs);
                updateBlogList();
            }
            
            updateCounts();
            updateRecentActivity();
        }

        // Update recent activity from localStorage
        function updateRecentActivity() {
            const activities = JSON.parse(localStorage.getItem('nsg_admin_activities') || '[]');
            const activityContainer = document.getElementById('recentActivity');
            
            if (activities.length === 0) {
                activityContainer.innerHTML = `
                    <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                        <i class="fas fa-info-circle text-blue-500 mr-3"></i>
                        <span class="text-gray-600">Welcome to NSG Health Admin Panel</span>
                        <span class="text-sm text-gray-400 ml-auto">Just now</span>
                    </div>
                `;
                return;
            }
            
            activityContainer.innerHTML = activities.slice(0, 5).map(activity => {
                const timeAgo = getTimeAgo(new Date(activity.timestamp));
                const icon = getActivityIcon(activity.type);
                const color = getActivityColor(activity.type);
                
                return `
                    <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                        <i class="fas ${icon} ${color} mr-3"></i>
                        <span class="text-gray-600">${getActivityMessage(activity)}</span>
                        <span class="text-sm text-gray-400 ml-auto">${timeAgo}</span>
                    </div>
                `;
            }).join('');
        }

        function getActivityIcon(type) {
            switch(type) {
                case 'login': return 'fa-sign-in-alt';
                case 'equipment_add': return 'fa-plus';
                case 'equipment_edit': return 'fa-edit';
                case 'equipment_delete': return 'fa-trash';
                case 'medicine_add': return 'fa-plus';
                case 'medicine_edit': return 'fa-edit';
                case 'medicine_delete': return 'fa-trash';
                case 'blog_add': return 'fa-plus';
                case 'blog_edit': return 'fa-edit';
                case 'blog_delete': return 'fa-trash';
                case 'appointment': return 'fa-calendar';
                case 'feedback': return 'fa-comment';
                case 'order': return 'fa-shopping-cart';
                default: return 'fa-info-circle';
            }
        }

        function getActivityColor(type) {
            switch(type) {
                case 'login': return 'text-green-500';
                case 'equipment_add': case 'medicine_add': case 'blog_add': return 'text-blue-500';
                case 'equipment_edit': case 'medicine_edit': case 'blog_edit': return 'text-yellow-500';
                case 'equipment_delete': case 'medicine_delete': case 'blog_delete': return 'text-red-500';
                case 'appointment': return 'text-purple-500';
                case 'feedback': return 'text-indigo-500';
                case 'order': return 'text-green-600';
                default: return 'text-gray-500';
            }
        }

        function getActivityMessage(activity) {
            switch(activity.type) {
                case 'login': 
                    return `${activity.user} (${activity.role}) logged in`;
                case 'equipment_add': 
                    return `Added equipment: ${activity.name}`;
                case 'equipment_edit': 
                    return `Updated equipment: ${activity.name}`;
                case 'equipment_delete': 
                    return `Deleted equipment: ${activity.name}`;
                case 'medicine_add': 
                    return `Added medicine: ${activity.name}`;
                case 'medicine_edit': 
                    return `Updated medicine: ${activity.name}`;
                case 'medicine_delete': 
                    return `Deleted medicine: ${activity.name}`;
                case 'blog_add': 
                    return `Published blog: ${activity.title}`;
                case 'blog_edit': 
                    return `Updated blog: ${activity.title}`;
                case 'blog_delete': 
                    return `Deleted blog: ${activity.title}`;
                case 'appointment': 
                    return `New appointment request from ${activity.name}`;
                case 'feedback': 
                    return `New feedback from ${activity.name}`;
                case 'order': 
                    return `New order for ${activity.product}`;
                default: 
                    return activity.message || 'Unknown activity';
            }
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            return `${days}d ago`;
        }

        // Log activity function
        function logActivity(type, data = {}) {
            const session = JSON.parse(localStorage.getItem('nsg_admin_session') || '{}');
            const activity = {
                type,
                ...data,
                user: session.name || 'Unknown',
                role: session.role || 'admin',
                timestamp: new Date().toISOString()
            };
            
            const activities = JSON.parse(localStorage.getItem('nsg_admin_activities') || '[]');
            activities.unshift(activity);
            if (activities.length > 100) activities.splice(100);
            localStorage.setItem('nsg_admin_activities', JSON.stringify(activities));
            
            updateRecentActivity();
        }

        // Utility functions
        function previewWebsite() {
            window.open('index.html', '_blank');
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Log the logout activity
                logActivity('logout');
                
                // Clear session data
                localStorage.removeItem('nsg_admin_session');
                
                // Redirect to login
                window.location.href = 'login.html';
            }
        }

        // Initialize on page load with enhanced authentication and mobile support
        function initializeCompleteData() {
            // Always initialize with complete equipment data from index.html
            const completeEquipmentData = [
                {
                    id: 'zinc-oxide-bandages',
                    name: 'Zinc Oxide Bandage (ZOP)',
                    category: 'bandages',
                    description: 'High-quality zinc oxide plaster bandages for secure wound dressing. Available in multiple sizes.',
                    price: 35,
                    variants: '1" x 4m - KSh 35, 2" x 4m - KSh 70, 3" x 4m - KSh 90, 4" x 4m - KSh 120, 6" x 4m - KSh 180',
                    image: ''
                },
                {
                    id: 'transpore-tapes',
                    name: 'Transpore Adhesive Tape',
                    category: 'bandages',
                    description: 'Clear, breathable adhesive tape for securing dressings and medical devices.',
                    price: 80,
                    variants: '2.5cm x 5m - KSh 80, 5cm x 5m - KSh 140, 7.5cm x 5m - KSh 170',
                    image: ''
                },
                {
                    id: 'crepe-bandages',
                    name: 'Crepe Bandage with Clip',
                    category: 'bandages',
                    description: 'Elastic support bandages with clips for sprains, strains, and compression therapy.',
                    price: 22,
                    variants: '2" x 4.5m - KSh 22, 3" x 4.5m - KSh 28, 4" x 4.5m - KSh 38, 6" x 4.5m - KSh 56',
                    image: ''
                },
                {
                    id: 'gauze-swabs',
                    name: 'Gauze Swabs (Pack of 100)',
                    category: 'bandages',
                    description: 'Sterile and non-sterile gauze swabs for wound cleaning and dressing.',
                    price: 170,
                    variants: '3x3 Non-Sterile - KSh 170, 3x3 Sterile - KSh 400, 4x4 Non-Sterile - KSh 300, 4x4 Sterile - KSh 650',
                    image: ''
                },
                {
                    id: 'primapore-dressings',
                    name: 'Primapore Adhesive Dressing',
                    category: 'bandages',
                    description: 'Waterproof adhesive dressings with non-adherent pad for post-operative wounds.',
                    price: 28,
                    variants: '6cm x 8.3cm - KSh 28, 15cm x 8cm - KSh 35, 20cm x 10cm - KSh 35, 25cm x 10cm - KSh 35',
                    image: ''
                },
                {
                    id: 'latex-examination-gloves',
                    name: 'Latex Examination Gloves',
                    category: 'gloves',
                    description: 'Powdered latex gloves for medical examinations. Pack of 100 pieces.',
                    price: 420,
                    variants: 'Medium - KSh 420, Large - KSh 425',
                    image: ''
                },
                {
                    id: 'nitrile-gloves',
                    name: 'Nitrile Gloves (Medium)',
                    category: 'gloves',
                    description: 'Powder-free nitrile gloves for sensitive procedures. Pack of 100 pieces.',
                    price: 550,
                    variants: 'Medium (100s) - KSh 550',
                    image: ''
                },
                {
                    id: 'surgical-gloves',
                    name: 'Surgical Gloves (Powder-Free)',
                    category: 'gloves',
                    description: 'Sterile latex surgical gloves, sizes 6.5-8.0. Pack of 12 pairs.',
                    price: 550,
                    variants: 'Size 6.5-8.0 (12 pairs) - KSh 550',
                    image: ''
                },
                {
                    id: 'disposable-syringes',
                    name: 'Disposable Syringes',
                    category: 'syringes',
                    description: 'Sterile disposable syringes without needles. Pack of 100 pieces.',
                    price: 400,
                    variants: '2ml - KSh 400, 5ml - KSh 500, 10ml - KSh 700, 20ml - KSh 850',
                    image: ''
                },
                {
                    id: 'syringes-with-needles',
                    name: 'Syringes with Needles',
                    category: 'syringes',
                    description: 'Complete syringe and needle sets for injections.',
                    price: 10,
                    variants: '2ml - KSh 12, 5ml - KSh 10, 10ml - KSh 12, 1ml Insulin - KSh 12',
                    image: ''
                },
                {
                    id: 'iv-cannulas',
                    name: 'IV Cannulas with Port',
                    category: 'syringes',
                    description: 'Sterile intravenous cannulas with injection port for IV access.',
                    price: 14,
                    variants: 'G16 - KSh 16, G18 - KSh 14, G20 - KSh 14, G22 - KSh 14, G24 - KSh 21, G26 - KSh 14',
                    image: ''
                },
                {
                    id: 'foley-catheters',
                    name: 'Foley Catheters',
                    category: 'catheters',
                    description: 'Sterile urinary catheters for bladder drainage. 2-way and 3-way options.',
                    price: 60,
                    variants: '2-Way (Various sizes) - KSh 60, 3-Way (Various sizes) - KSh 85',
                    image: ''
                },
                {
                    id: 'feeding-tubes',
                    name: 'Feeding Tubes',
                    category: 'catheters',
                    description: 'Nasogastric feeding tubes for enteral nutrition. Multiple sizes available.',
                    price: 24,
                    variants: 'Various sizes - KSh 24',
                    image: ''
                },
                {
                    id: 'dual-head-stethoscope',
                    name: 'Dual Head Stethoscope',
                    category: 'diagnostic',
                    description: 'Professional quality stethoscope for cardiac and pulmonary examination.',
                    price: 170,
                    variants: 'Standard - KSh 170',
                    image: ''
                },
                {
                    id: 'blood-pressure-monitors',
                    name: 'Blood Pressure Monitors',
                    category: 'diagnostic',
                    description: 'Digital BP monitors for accurate blood pressure measurement.',
                    price: 4800,
                    variants: 'Wrist BP Monitor - KSh 4,800, Omron M1 Basic - KSh 5,000, Omron M2 Basic - KSh 6,500',
                    image: ''
                },
                {
                    id: 'digital-thermometer',
                    name: 'Digital Thermometer',
                    category: 'diagnostic',
                    description: 'Accurate digital thermometer for body temperature measurement.',
                    price: 150,
                    variants: 'Standard - KSh 150',
                    image: ''
                },
                {
                    id: 'surgical-sutures',
                    name: 'Surgical Sutures',
                    category: 'surgical',
                    description: 'High-quality sutures for wound closure. Pack of 12 pieces.',
                    price: 1300,
                    variants: 'Chromic Catgut - KSh 1,300, Nylon Sutures - KSh 1,300, Vicryl (Polyglactin) - KSh 1,300',
                    image: ''
                },
                {
                    id: 'surgical-blades',
                    name: 'Surgical Blades',
                    category: 'surgical',
                    description: 'Sterile disposable surgical blades. Pack of 100 pieces.',
                    price: 620,
                    variants: 'Grade 23 - KSh 620, Grade 24 - KSh 620',
                    image: ''
                },
                {
                    id: 'pregnancy-test-strips',
                    name: 'Pregnancy Test Strips',
                    category: 'lab',
                    description: 'Rapid pregnancy test strips with high accuracy. Pack of 10.',
                    price: 70,
                    variants: 'Standard (10 strips) - KSh 70',
                    image: ''
                },
                {
                    id: 'blood-glucose-monitor',
                    name: 'Blood Glucose Monitor',
                    category: 'lab',
                    description: 'Plusmed glucose monitor with test strips for diabetes management.',
                    price: 380,
                    variants: 'Monitor (10 strips) - KSh 380, Test Strips (100s) - KSh 850',
                    image: ''
                },
                {
                    id: 'urinalysis-test-strips',
                    name: 'Urinalysis Test Strips',
                    category: 'lab',
                    description: '10-parameter urine test strips for comprehensive urinalysis. Pack of 100.',
                    price: 125,
                    variants: 'Standard (100 strips) - KSh 125',
                    image: ''
                }
            ];
            
            // Check if we need to initialize or update data
            const storedEquipment = localStorage.getItem('nsg_equipment');
            if (!storedEquipment || JSON.parse(storedEquipment).length === 0) {
                console.log('Initializing equipment data...');
                equipmentData = completeEquipmentData;
                localStorage.setItem('nsg_equipment', JSON.stringify(equipmentData));
                console.log('Equipment data initialized with', equipmentData.length, 'items');
            } else {
                // Load existing data but merge with any missing items
                const existing = JSON.parse(storedEquipment);
                const existingIds = existing.map(item => item.id);
                const missingItems = completeEquipmentData.filter(item => !existingIds.includes(item.id));
                
                if (missingItems.length > 0) {
                    equipmentData = [...existing, ...missingItems];
                    localStorage.setItem('nsg_equipment', JSON.stringify(equipmentData));
                    console.log('Added', missingItems.length, 'missing equipment items');
                } else {
                    equipmentData = existing;
                }
            }
            
            // Load all other data
            loadData();
            
            // Force update displays
            updateEquipmentList();
            updateCounts();
        }

        // Image preview functionality
        function setupImagePreviewHandlers() {
            // Equipment image preview
            const equipmentImageInput = document.getElementById('equipmentImage');
            const equipmentPreview = document.getElementById('equipmentImagePreview');
            const equipmentPreviewImg = document.getElementById('equipmentPreviewImg');
            
            if (equipmentImageInput) {
                equipmentImageInput.addEventListener('change', function(e) {
                    handleImagePreview(e, equipmentPreview, equipmentPreviewImg);
                });
            }
            
            // Medicine image preview
            const medicineImageInput = document.getElementById('medicineImage');
            const medicinePreview = document.getElementById('medicineImagePreview');
            const medicinePreviewImg = document.getElementById('medicinePreviewImg');
            
            if (medicineImageInput) {
                medicineImageInput.addEventListener('change', function(e) {
                    handleImagePreview(e, medicinePreview, medicinePreviewImg);
                });
            }
            
            // Blog image preview
            const blogImageInput = document.getElementById('blogImage');
            const blogPreview = document.getElementById('blogImagePreview');
            const blogPreviewImg = document.getElementById('blogPreviewImg');
            
            if (blogImageInput) {
                blogImageInput.addEventListener('change', function(e) {
                    handleImagePreview(e, blogPreview, blogPreviewImg);
                });
            }
        }

        // Handle image preview
        function handleImagePreview(event, previewDiv, previewImg) {
            const file = event.target.files[0];
            
            if (file) {
                // Check if file is an image
                if (!file.type.startsWith('image/')) {
                    showNotification('Please select a valid image file', 'error');
                    return;
                }
                
                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('Image size should be less than 5MB', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    previewDiv.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                previewDiv.classList.add('hidden');
            }
        }

        // Convert file to base64 for storage
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
    </script>
    </div> <!-- End admin content wrapper -->
</body>
</html>
